From 9437fb8c26716a2aa925c8fffa7a0b2af96a35dc Mon Sep 17 00:00:00 2001
From: Aleksander Morgado <aleksander@aleksander.es>
Date: Mon, 25 Jul 2016 14:02:27 +0200
Subject: [PATCH 06/11] build: allow disabling signal interface support

---
 cli/Makefile.am                              |  5 ++-
 cli/mmcli.c                                  |  6 ++++
 cli/mmcli.h                                  |  2 ++
 configure.ac                                 | 15 +++++++++
 docs/reference/api/ModemManager-sections.txt |  1 +
 include/ModemManager-version.h.in            | 15 +++++++++
 introspection/Makefile.am                    |  5 ++-
 libmm-glib/Makefile.am                       | 22 +++++++++----
 libmm-glib/generated/Makefile.am             | 15 +++++++--
 libmm-glib/libmm-glib.h                      |  8 +++--
 libmm-glib/mm-manager.c                      |  2 ++
 libmm-glib/mm-object.c                       |  4 +++
 libmm-glib/mm-object.h                       | 11 +++++--
 plugins/huawei/mm-broadband-modem-huawei.c   | 35 +++++++++++++++++++--
 src/Makefile.am                              |  9 ++++--
 src/mm-broadband-modem-mbim.c                | 16 ++++++++--
 src/mm-broadband-modem-qmi.c                 | 19 +++++++++--
 src/mm-broadband-modem.c                     | 47 +++++++++++++++++++++++++++-
 src/mm-modem-helpers.c                       |  4 +++
 src/mm-modem-helpers.h                       | 40 +++++++++++++----------
 src/tests/test-modem-helpers.c               |  6 ++++
 21 files changed, 245 insertions(+), 42 deletions(-)

diff --git a/cli/Makefile.am b/cli/Makefile.am
index 60f3d293..4bae8144 100644
--- a/cli/Makefile.am
+++ b/cli/Makefile.am
@@ -21,7 +21,6 @@ mmcli_SOURCES = \
 	mmcli-modem-cdma.c \
 	mmcli-modem-simple.c \
 	mmcli-modem-firmware.c \
-	mmcli-modem-signal.c \
 	mmcli-modem-oma.c \
 	mmcli-bearer.c \
 	mmcli-sim.c \
@@ -49,6 +48,10 @@ mmcli_SOURCES += \
 	$(NULL)
 endif
 
+if WITH_INTERFACE_SIGNAL
+mmcli_SOURCES += mmcli-modem-signal.c
+endif
+
 mmcli_LDADD = \
 	$(MMCLI_LIBS) \
 	$(top_builddir)/libmm-glib/libmm-glib.la \
diff --git a/cli/mmcli.c b/cli/mmcli.c
index a4973e91..a4628367 100644
--- a/cli/mmcli.c
+++ b/cli/mmcli.c
@@ -216,8 +216,10 @@ main (gint argc, gchar **argv)
 #endif
     g_option_context_add_group (context,
                                 mmcli_modem_firmware_get_option_group ());
+#if MM_INTERFACE_SIGNAL_SUPPORTED
     g_option_context_add_group (context,
                                 mmcli_modem_signal_get_option_group ());
+#endif
     g_option_context_add_group (context,
                                 mmcli_modem_oma_get_option_group ());
     g_option_context_add_group (context,
@@ -369,6 +371,7 @@ main (gint argc, gchar **argv)
         else
             mmcli_modem_firmware_run_synchronous (connection);
     }
+#if MM_INTERFACE_SIGNAL_SUPPORTED
     /* Modem Signal options? */
     else if (mmcli_modem_signal_options_enabled ()) {
         if (async_flag)
@@ -376,6 +379,7 @@ main (gint argc, gchar **argv)
         else
             mmcli_modem_signal_run_synchronous (connection);
     }
+#endif
     /* Modem Oma options? */
     else if (mmcli_modem_oma_options_enabled ()) {
         if (async_flag)
@@ -429,8 +433,10 @@ main (gint argc, gchar **argv)
 #endif
     } else if (mmcli_modem_firmware_options_enabled ()) {
         mmcli_modem_firmware_shutdown ();
+#if MM_INTERFACE_SIGNAL_SUPPORTED
     } else if (mmcli_modem_signal_options_enabled ()) {
         mmcli_modem_signal_shutdown ();
+#endif
     } else if (mmcli_modem_oma_options_enabled ()) {
         mmcli_modem_oma_shutdown ();
     }  else if (mmcli_sim_options_enabled ()) {
diff --git a/cli/mmcli.h b/cli/mmcli.h
index b13dd2d0..517a9aba 100644
--- a/cli/mmcli.h
+++ b/cli/mmcli.h
@@ -117,6 +117,7 @@ void          mmcli_modem_firmware_run_asynchronous   (GDBusConnection *connecti
 void          mmcli_modem_firmware_run_synchronous    (GDBusConnection *connection);
 void          mmcli_modem_firmware_shutdown           (void);
 
+#if MM_INTERFACE_SIGNAL_SUPPORTED
 /* Signal group */
 GOptionGroup *mmcli_modem_signal_get_option_group   (void);
 gboolean      mmcli_modem_signal_options_enabled    (void);
@@ -124,6 +125,7 @@ void          mmcli_modem_signal_run_asynchronous   (GDBusConnection *connection
                                                      GCancellable    *cancellable);
 void          mmcli_modem_signal_run_synchronous    (GDBusConnection *connection);
 void          mmcli_modem_signal_shutdown           (void);
+#endif
 
 /* Oma group */
 GOptionGroup *mmcli_modem_oma_get_option_group   (void);
diff --git a/configure.ac b/configure.ac
index bd2e015b..b51dfe10 100644
--- a/configure.ac
+++ b/configure.ac
@@ -417,6 +417,20 @@ else
 fi
 AC_SUBST(MM_INTERFACE_VOICE_SUPPORTED)
 
+dnl-----------------------------------------------------------------------------
+dnl Signal interface
+dnl
+
+AC_ARG_WITH(interface-signal, AS_HELP_STRING([--without-interface-signal], [Build without signal interface support]), [], [with_interface_signal=yes])
+AM_CONDITIONAL(WITH_INTERFACE_SIGNAL, test "x$with_interface_signal" = "xyes")
+if test "x$with_interface_signal" = "xyes"; then
+    MM_INTERFACE_SIGNAL_SUPPORTED=1
+else
+    with_interface_signal=no
+    MM_INTERFACE_SIGNAL_SUPPORTED=0
+fi
+AC_SUBST(MM_INTERFACE_SIGNAL_SUPPORTED)
+
 dnl-----------------------------------------------------------------------------
 dnl Compiler warnings
 dnl
@@ -515,6 +529,7 @@ echo "
       messaging:               ${with_interface_messaging}
       time:                    ${with_interface_time}
       voice:                   ${with_interface_voice}
+      signal:                  ${with_interface_signal}
 
     Miscellaneous:
       gobject introspection:   ${found_introspection}
diff --git a/docs/reference/api/ModemManager-sections.txt b/docs/reference/api/ModemManager-sections.txt
index 963f7838..13dca3cd 100644
--- a/docs/reference/api/ModemManager-sections.txt
+++ b/docs/reference/api/ModemManager-sections.txt
@@ -9,6 +9,7 @@ MM_INTERFACE_LOCATION_SUPPORTED
 MM_INTERFACE_MESSAGING_SUPPORTED
 MM_INTERFACE_TIME_SUPPORTED
 MM_INTERFACE_VOICE_SUPPORTED
+MM_INTERFACE_SIGNAL_SUPPORTED
 </SECTION>
 
 <SECTION>
diff --git a/include/ModemManager-version.h.in b/include/ModemManager-version.h.in
index 19abfe83..34f28ad1 100644
--- a/include/ModemManager-version.h.in
+++ b/include/ModemManager-version.h.in
@@ -127,4 +127,19 @@
  */
 #define MM_INTERFACE_VOICE_SUPPORTED @MM_INTERFACE_VOICE_SUPPORTED@
 
+/**
+ * MM_INTERFACE_SIGNAL_SUPPORTED:
+ *
+ * Symbol to expose whether Signal interface is supported. The symbol is always
+ * defined and set to either or 1 or 0.
+ *
+ * E.g.:
+ * |[
+ *  #if MM_INTERFACE_SIGNAL_SUPPORTED
+ *      // do something
+ *  #endif
+ * ]|
+ */
+#define MM_INTERFACE_SIGNAL_SUPPORTED @MM_INTERFACE_SIGNAL_SUPPORTED@
+
 #endif /* _MM_VERSION_H_ */
diff --git a/introspection/Makefile.am b/introspection/Makefile.am
index 54b5d0ae..12c2e5cf 100644
--- a/introspection/Makefile.am
+++ b/introspection/Makefile.am
@@ -15,7 +15,6 @@ xml_DATA = \
 	org.freedesktop.ModemManager1.Modem.Modem3gpp.Ussd.xml \
 	org.freedesktop.ModemManager1.Modem.Firmware.xml \
 	org.freedesktop.ModemManager1.Modem.Oma.xml \
-	org.freedesktop.ModemManager1.Modem.Signal.xml \
 	$(NULL)
 
 if WITH_INTERFACE_LOCATION
@@ -37,6 +36,10 @@ xml_DATA += \
 	$(NULL)
 endif
 
+if WITH_INTERFACE_SIGNAL
+xml_DATA += org.freedesktop.ModemManager1.Modem.Signal.xml
+endif
+
 all.xml: $(xml_DATA) Makefile
 	$(AM_V_GEN)	\
 		rm -f $@; \
diff --git a/libmm-glib/Makefile.am b/libmm-glib/Makefile.am
index 0bdf3d74..9a12b969 100644
--- a/libmm-glib/Makefile.am
+++ b/libmm-glib/Makefile.am
@@ -26,8 +26,6 @@ libmm_glib_la_SOURCES = \
 	mm-modem-simple.c \
 	mm-modem-firmware.h \
 	mm-modem-firmware.c \
-	mm-modem-signal.h \
-	mm-modem-signal.c \
 	mm-modem-oma.h \
 	mm-modem-oma.c \
 	mm-sim.h \
@@ -52,8 +50,6 @@ libmm_glib_la_SOURCES = \
 	mm-firmware-properties.c \
 	mm-cdma-manual-activation-properties.h \
 	mm-cdma-manual-activation-properties.c \
-	mm-signal.h \
-	mm-signal.c \
 	mm-kernel-event-properties.h \
 	mm-kernel-event-properties.c \
 	$(NULL)
@@ -105,6 +101,15 @@ libmm_glib_la_SOURCES += \
 	$(NULL)
 endif
 
+if WITH_INTERFACE_SIGNAL
+libmm_glib_la_SOURCES += \
+	mm-modem-signal.h \
+	mm-modem-signal.c \
+	mm-signal.h \
+	mm-signal.c \
+	$(NULL)
+endif
+
 libmm_glib_la_CPPFLAGS = \
 	-I$(srcdir) \
 	-I$(top_srcdir) \
@@ -143,7 +148,6 @@ include_HEADERS = \
 	mm-modem-3gpp-ussd.h \
 	mm-modem-cdma.h \
 	mm-modem-firmware.h \
-	mm-modem-signal.h \
 	mm-modem-oma.h \
 	mm-modem-simple.h \
 	mm-sim.h \
@@ -156,7 +160,6 @@ include_HEADERS = \
 	mm-unlock-retries.h \
 	mm-firmware-properties.h \
 	mm-cdma-manual-activation-properties.h \
-	mm-signal.h \
 	mm-kernel-event-properties.h \
 	$(NULL)
 
@@ -194,6 +197,13 @@ include_HEADERS += \
 	$(NULL)
 endif
 
+if WITH_INTERFACE_SIGNAL
+include_HEADERS += \
+	mm-modem-signal.h \
+	mm-signal.h \
+	$(NULL)
+endif
+
 CLEANFILES =
 
 # Introspection
diff --git a/libmm-glib/generated/Makefile.am b/libmm-glib/generated/Makefile.am
index 227d3c1c..2d2208ae 100644
--- a/libmm-glib/generated/Makefile.am
+++ b/libmm-glib/generated/Makefile.am
@@ -36,7 +36,6 @@ GENERATED_DOC = \
 	mm-gdbus-doc-org.freedesktop.ModemManager1.Modem.Modem3gpp.xml \
 	mm-gdbus-doc-org.freedesktop.ModemManager1.Modem.Modem3gpp.Ussd.xml \
 	mm-gdbus-doc-org.freedesktop.ModemManager1.Modem.Simple.xml \
-	mm-gdbus-doc-org.freedesktop.ModemManager1.Modem.Signal.xml \
 	$(NULL)
 
 if WITH_INTERFACE_LOCATION
@@ -65,6 +64,10 @@ GENERATED_DOC += \
 	$(NULL)
 endif
 
+if WITH_INTERFACE_SIGNAL
+GENERATED_DOC += mm-gdbus-doc-org.freedesktop.ModemManager1.Modem.Signal.xml
+endif
+
 BUILT_SOURCES = $(GENERATED_H) $(GENERATED_C) $(GENERATED_DOC)
 
 # Enum types
@@ -148,7 +151,6 @@ mm_gdbus_modem_generated = \
 	mm-gdbus-doc-org.freedesktop.ModemManager1.Modem.Modem3gpp.xml \
 	mm-gdbus-doc-org.freedesktop.ModemManager1.Modem.Modem3gpp.Ussd.xml \
 	mm-gdbus-doc-org.freedesktop.ModemManager1.Modem.Simple.xml \
-	mm-gdbus-doc-org.freedesktop.ModemManager1.Modem.Signal.xml \
 	$(NULL)
 
 if WITH_INTERFACE_LOCATION
@@ -167,6 +169,10 @@ if WITH_INTERFACE_VOICE
 mm_gdbus_modem_generated += mm-gdbus-doc-org.freedesktop.ModemManager1.Modem.Voice.xml
 endif
 
+if WITH_INTERFACE_SIGNAL
+mm_gdbus_modem_generated += mm-gdbus-doc-org.freedesktop.ModemManager1.Modem.Signal.xml
+endif
+
 mm_gdbus_modem_deps = \
 	$(top_srcdir)/introspection/org.freedesktop.ModemManager1.Modem.xml \
 	$(top_srcdir)/introspection/org.freedesktop.ModemManager1.Modem.Firmware.xml \
@@ -175,7 +181,6 @@ mm_gdbus_modem_deps = \
 	$(top_srcdir)/introspection/org.freedesktop.ModemManager1.Modem.Modem3gpp.xml \
 	$(top_srcdir)/introspection/org.freedesktop.ModemManager1.Modem.Modem3gpp.Ussd.xml \
 	$(top_srcdir)/introspection/org.freedesktop.ModemManager1.Modem.Simple.xml \
-	$(top_srcdir)/introspection/org.freedesktop.ModemManager1.Modem.Signal.xml \
 	$(NULL)
 
 if WITH_INTERFACE_LOCATION
@@ -194,6 +199,10 @@ if WITH_INTERFACE_VOICE
 mm_gdbus_modem_deps += $(top_srcdir)/introspection/org.freedesktop.ModemManager1.Modem.Voice.xml
 endif
 
+if WITH_INTERFACE_SIGNAL
+mm_gdbus_modem_deps += $(top_srcdir)/introspection/org.freedesktop.ModemManager1.Modem.Signal.xml
+endif
+
 mm-gdbus-modem.c: $(mm_gdbus_modem_deps)
 	$(AM_V_GEN) $(GDBUS_CODEGEN) \
 		--interface-prefix org.freedesktop.ModemManager1. \
diff --git a/libmm-glib/libmm-glib.h b/libmm-glib/libmm-glib.h
index 2330ee15..693d51e9 100644
--- a/libmm-glib/libmm-glib.h
+++ b/libmm-glib/libmm-glib.h
@@ -52,7 +52,9 @@
 #  include <mm-modem-time.h>
 # endif
 # include <mm-modem-firmware.h>
-# include <mm-modem-signal.h>
+# if MM_INTERFACE_SIGNAL_SUPPORTED
+#  include <mm-modem-signal.h>
+# endif
 # include <mm-modem-oma.h>
 #endif
 
@@ -87,7 +89,9 @@
 #endif
 #include <mm-firmware-properties.h>
 #include <mm-cdma-manual-activation-properties.h>
-#include <mm-signal.h>
+#if MM_INTERFACE_SIGNAL_SUPPORTED
+# include <mm-signal.h>
+#endif
 #include <mm-kernel-event-properties.h>
 
 /* generated */
diff --git a/libmm-glib/mm-manager.c b/libmm-glib/mm-manager.c
index aaf15c43..86fd427f 100644
--- a/libmm-glib/mm-manager.c
+++ b/libmm-glib/mm-manager.c
@@ -79,7 +79,9 @@ get_proxy_type (GDBusObjectManagerClient *manager,
 #if MM_INTERFACE_TIME_SUPPORTED
         g_hash_table_insert (lookup_hash, "org.freedesktop.ModemManager1.Modem.Time",           GSIZE_TO_POINTER (MM_TYPE_MODEM_TIME));
 #endif
+#if MM_INTERFACE_SIGNAL_SUPPORTED
         g_hash_table_insert (lookup_hash, "org.freedesktop.ModemManager1.Modem.Signal",         GSIZE_TO_POINTER (MM_TYPE_MODEM_SIGNAL));
+#endif
         g_hash_table_insert (lookup_hash, "org.freedesktop.ModemManager1.Modem.Firmware",       GSIZE_TO_POINTER (MM_TYPE_MODEM_FIRMWARE));
         g_hash_table_insert (lookup_hash, "org.freedesktop.ModemManager1.Modem.Oma",            GSIZE_TO_POINTER (MM_TYPE_MODEM_OMA));
         g_hash_table_insert (lookup_hash, "org.freedesktop.ModemManager1.Modem.ModemCdma",      GSIZE_TO_POINTER (MM_TYPE_MODEM_CDMA));
diff --git a/libmm-glib/mm-object.c b/libmm-glib/mm-object.c
index 7943d1cd..c6a424fc 100644
--- a/libmm-glib/mm-object.c
+++ b/libmm-glib/mm-object.c
@@ -461,6 +461,8 @@ mm_object_peek_modem_firmware (MMObject *self)
     return (MMModemFirmware *)mm_gdbus_object_peek_modem_firmware (MM_GDBUS_OBJECT (self));
 }
 
+#if MM_INTERFACE_SIGNAL_SUPPORTED
+
 /*****************************************************************************/
 
 /**
@@ -497,6 +499,8 @@ mm_object_peek_modem_signal (MMObject *self)
     return (MMModemSignal *)mm_gdbus_object_peek_modem_signal (MM_GDBUS_OBJECT (self));
 }
 
+#endif /* MM_INTERFACE_SIGNAL_SUPPORTED */
+
 /*****************************************************************************/
 
 /**
diff --git a/libmm-glib/mm-object.h b/libmm-glib/mm-object.h
index 14d299e5..57060ee5 100644
--- a/libmm-glib/mm-object.h
+++ b/libmm-glib/mm-object.h
@@ -49,7 +49,9 @@
 # include "mm-modem-voice.h"
 #endif
 #include "mm-modem-firmware.h"
-#include "mm-modem-signal.h"
+#if MM_INTERFACE_SIGNAL_SUPPORTED
+# include "mm-modem-signal.h"
+#endif
 #include "mm-modem-oma.h"
 
 G_BEGIN_DECLS
@@ -92,7 +94,6 @@ MMModem3gppUssd  *mm_object_get_modem_3gpp_ussd  (MMObject *self);
 MMModemCdma      *mm_object_get_modem_cdma       (MMObject *self);
 MMModemSimple    *mm_object_get_modem_simple     (MMObject *self);
 MMModemFirmware  *mm_object_get_modem_firmware   (MMObject *self);
-MMModemSignal    *mm_object_get_modem_signal     (MMObject *self);
 MMModemOma       *mm_object_get_modem_oma        (MMObject *self);
 
 MMModem          *mm_object_peek_modem           (MMObject *self);
@@ -101,7 +102,6 @@ MMModem3gppUssd  *mm_object_peek_modem_3gpp_ussd (MMObject *self);
 MMModemCdma      *mm_object_peek_modem_cdma      (MMObject *self);
 MMModemSimple    *mm_object_peek_modem_simple    (MMObject *self);
 MMModemFirmware  *mm_object_peek_modem_firmware  (MMObject *self);
-MMModemSignal    *mm_object_peek_modem_signal    (MMObject *self);
 MMModemOma       *mm_object_peek_modem_oma       (MMObject *self);
 
 #if MM_INTERFACE_LOCATION_SUPPORTED
@@ -124,6 +124,11 @@ MMModemVoice     *mm_object_get_modem_voice      (MMObject *self);
 MMModemVoice     *mm_object_peek_modem_voice     (MMObject *self);
 #endif
 
+#if MM_INTERFACE_SIGNAL_SUPPORTED
+MMModemSignal    *mm_object_get_modem_signal     (MMObject *self);
+MMModemSignal    *mm_object_peek_modem_signal    (MMObject *self);
+#endif
+
 G_END_DECLS
 
 #endif /* _MM_OBJECT_H_ */
diff --git a/plugins/huawei/mm-broadband-modem-huawei.c b/plugins/huawei/mm-broadband-modem-huawei.c
index 1cad5f4a..9a0d53bd 100644
--- a/plugins/huawei/mm-broadband-modem-huawei.c
+++ b/plugins/huawei/mm-broadband-modem-huawei.c
@@ -40,7 +40,6 @@
 #include "mm-iface-modem-3gpp.h"
 #include "mm-iface-modem-3gpp-ussd.h"
 #include "mm-iface-modem-cdma.h"
-#include "mm-iface-modem-signal.h"
 #include "mm-broadband-modem-huawei.h"
 #include "mm-broadband-bearer-huawei.h"
 #include "mm-broadband-bearer.h"
@@ -60,11 +59,14 @@
 # include "mm-call-huawei.h"
 #endif
 
+#if MM_INTERFACE_SIGNAL_SUPPORTED
+# include "mm-iface-modem-signal.h"
+#endif
+
 static void iface_modem_init (MMIfaceModem *iface);
 static void iface_modem_3gpp_init (MMIfaceModem3gpp *iface);
 static void iface_modem_3gpp_ussd_init (MMIfaceModem3gppUssd *iface);
 static void iface_modem_cdma_init (MMIfaceModemCdma *iface);
-static void iface_modem_signal_init (MMIfaceModemSignal *iface);
 
 static MMIfaceModem *iface_modem_parent;
 static MMIfaceModem3gpp *iface_modem_3gpp_parent;
@@ -84,6 +86,10 @@ static void iface_modem_voice_init (MMIfaceModemVoice *iface);
 static MMIfaceModemVoice *iface_modem_voice_parent;
 #endif
 
+#if MM_INTERFACE_SIGNAL_SUPPORTED
+static void iface_modem_signal_init (MMIfaceModemSignal *iface);
+#endif
+
 G_DEFINE_TYPE_EXTENDED (MMBroadbandModemHuawei, mm_broadband_modem_huawei, MM_TYPE_BROADBAND_MODEM, 0,
                         G_IMPLEMENT_INTERFACE (MM_TYPE_IFACE_MODEM, iface_modem_init)
                         G_IMPLEMENT_INTERFACE (MM_TYPE_IFACE_MODEM_3GPP, iface_modem_3gpp_init)
@@ -98,7 +104,9 @@ G_DEFINE_TYPE_EXTENDED (MMBroadbandModemHuawei, mm_broadband_modem_huawei, MM_TY
 #if MM_INTERFACE_VOICE_SUPPORTED
                         G_IMPLEMENT_INTERFACE (MM_TYPE_IFACE_MODEM_VOICE, iface_modem_voice_init)
 #endif
+#if MM_INTERFACE_SIGNAL_SUPPORTED
                         G_IMPLEMENT_INTERFACE (MM_TYPE_IFACE_MODEM_SIGNAL, iface_modem_signal_init)
+#endif
                         )
 
 typedef enum {
@@ -107,6 +115,8 @@ typedef enum {
     FEATURE_SUPPORTED
 } FeatureSupport;
 
+#if MM_INTERFACE_SIGNAL_SUPPORTED
+
 typedef struct {
     MMSignal *cdma;
     MMSignal *evdo;
@@ -115,6 +125,8 @@ typedef struct {
     MMSignal *lte;
 } DetailedSignal;
 
+#endif
+
 struct _MMBroadbandModemHuaweiPrivate {
     /* Regex for signal quality related notifications */
     GRegex *rssi_regex;
@@ -178,7 +190,9 @@ struct _MMBroadbandModemHuaweiPrivate {
     GArray *syscfgex_supported_modes;
     GArray *prefmode_supported_modes;
 
+#if MM_INTERFACE_SIGNAL_SUPPORTED
     DetailedSignal detailed_signal;
+#endif
 };
 
 /*****************************************************************************/
@@ -1749,6 +1763,8 @@ huawei_ndisstat_changed (MMPortSerialAt *port,
     g_object_unref (list);
 }
 
+#if MM_INTERFACE_SIGNAL_SUPPORTED
+
 static void
 detailed_signal_clear (DetailedSignal *signal)
 {
@@ -1879,6 +1895,8 @@ huawei_hcsq_changed (MMPortSerialAt *port,
     }
 }
 
+#endif /* MM_INTERFACE_SIGNAL_SUPPORTED */
+
 static void
 set_3gpp_unsolicited_events_handlers (MMBroadbandModemHuawei *self,
                                       gboolean enable)
@@ -1922,12 +1940,14 @@ set_3gpp_unsolicited_events_handlers (MMBroadbandModemHuawei *self,
             enable ? self : NULL,
             NULL);
 
+#if MM_INTERFACE_SIGNAL_SUPPORTED
         mm_port_serial_at_add_unsolicited_msg_handler (
             port,
             self->priv->hcsq_regex,
             enable ? (MMPortSerialAtUnsolicitedMsgFn)huawei_hcsq_changed : NULL,
             enable ? self : NULL,
             NULL);
+#endif
     }
 
     g_list_free_full (ports, g_object_unref);
@@ -3989,6 +4009,8 @@ modem_time_check_support (MMIfaceModemTime *self,
 
 #endif /* MM_INTERFACE_TIME_SUPPORTED */
 
+#if MM_INTERFACE_SIGNAL_SUPPORTED
+
 /*****************************************************************************/
 /* Check support (Signal interface) */
 
@@ -4125,6 +4147,8 @@ signal_load_values (MMIfaceModemSignal *_self,
                               task);
 }
 
+#endif /* MM_INTERFACE_SIGNAL_SUPPORTED */
+
 /*****************************************************************************/
 /* Setup ports (Broadband modem class) */
 
@@ -4386,10 +4410,11 @@ mm_broadband_modem_huawei_init (MMBroadbandModemHuawei *self)
 static void
 dispose (GObject *object)
 {
+#if MM_INTERFACE_SIGNAL_SUPPORTED
     MMBroadbandModemHuawei *self = MM_BROADBAND_MODEM_HUAWEI (object);
 
     detailed_signal_clear (&self->priv->detailed_signal);
-
+#endif
     G_OBJECT_CLASS (mm_broadband_modem_huawei_parent_class)->dispose (object);
 }
 
@@ -4569,6 +4594,8 @@ iface_modem_voice_init (MMIfaceModemVoice *iface)
 
 #endif
 
+#if MM_INTERFACE_SIGNAL_SUPPORTED
+
 static void
 iface_modem_signal_init (MMIfaceModemSignal *iface)
 {
@@ -4578,6 +4605,8 @@ iface_modem_signal_init (MMIfaceModemSignal *iface)
     iface->load_values_finish = signal_load_values_finish;
 }
 
+#endif
+
 static void
 mm_broadband_modem_huawei_class_init (MMBroadbandModemHuaweiClass *klass)
 {
diff --git a/src/Makefile.am b/src/Makefile.am
index 38406baa..e18c43a7 100644
--- a/src/Makefile.am
+++ b/src/Makefile.am
@@ -321,8 +321,6 @@ ModemManager_SOURCES = \
 	mm-iface-modem-simple.c \
 	mm-iface-modem-firmware.h \
 	mm-iface-modem-firmware.c \
-	mm-iface-modem-signal.h \
-	mm-iface-modem-signal.c \
 	mm-iface-modem-oma.h \
 	mm-iface-modem-oma.c \
 	mm-broadband-modem.h \
@@ -371,6 +369,13 @@ ModemManager_SOURCES += \
 	$(NULL)
 endif
 
+if WITH_INTERFACE_SIGNAL
+ModemManager_SOURCES += \
+	mm-iface-modem-signal.h \
+	mm-iface-modem-signal.c \
+	$(NULL)
+endif
+
 nodist_ModemManager_SOURCES = $(DAEMON_ENUMS_GENERATED)
 
 # Additional Polkit support
diff --git a/src/mm-broadband-modem-mbim.c b/src/mm-broadband-modem-mbim.c
index 166a5ce7..31621594 100644
--- a/src/mm-broadband-modem-mbim.c
+++ b/src/mm-broadband-modem-mbim.c
@@ -34,7 +34,6 @@
 #include "mm-bearer-list.h"
 #include "mm-iface-modem.h"
 #include "mm-iface-modem-3gpp.h"
-#include "mm-iface-modem-signal.h"
 
 #if MM_INTERFACE_LOCATION_SUPPORTED
 # include "mm-iface-modem-location.h"
@@ -46,13 +45,16 @@
 # include "mm-sms-part-3gpp.h"
 #endif
 
+#if MM_INTERFACE_SIGNAL_SUPPORTED
+# include "mm-iface-modem-signal.h"
+#endif
+
 #if defined WITH_QMI
 # include <libqmi-glib.h>
 #endif
 
 static void iface_modem_init (MMIfaceModem *iface);
 static void iface_modem_3gpp_init (MMIfaceModem3gpp *iface);
-static void iface_modem_signal_init    (MMIfaceModemSignal    *iface);
 
 #if MM_INTERFACE_LOCATION_SUPPORTED
 static void iface_modem_location_init  (MMIfaceModemLocation  *iface);
@@ -62,6 +64,10 @@ static void iface_modem_location_init  (MMIfaceModemLocation  *iface);
 static void iface_modem_messaging_init (MMIfaceModemMessaging *iface);
 #endif
 
+#if MM_INTERFACE_SIGNAL_SUPPORTED
+static void iface_modem_signal_init (MMIfaceModemSignal *iface);
+#endif
+
 G_DEFINE_TYPE_EXTENDED (MMBroadbandModemMbim, mm_broadband_modem_mbim, MM_TYPE_BROADBAND_MODEM, 0,
                         G_IMPLEMENT_INTERFACE (MM_TYPE_IFACE_MODEM, iface_modem_init)
                         G_IMPLEMENT_INTERFACE (MM_TYPE_IFACE_MODEM_3GPP, iface_modem_3gpp_init)
@@ -71,7 +77,9 @@ G_DEFINE_TYPE_EXTENDED (MMBroadbandModemMbim, mm_broadband_modem_mbim, MM_TYPE_B
 #if MM_INTERFACE_MESSAGING_SUPPORTED
                         G_IMPLEMENT_INTERFACE (MM_TYPE_IFACE_MODEM_MESSAGING, iface_modem_messaging_init)
 #endif
+#if MM_INTERFACE_SIGNAL_SUPPORTED
                         G_IMPLEMENT_INTERFACE (MM_TYPE_IFACE_MODEM_SIGNAL, iface_modem_signal_init)
+#endif
                         )
 
 typedef enum {
@@ -3506,6 +3514,8 @@ iface_modem_messaging_init (MMIfaceModemMessaging *iface)
 
 #endif
 
+#if MM_INTERFACE_SIGNAL_SUPPORTED
+
 static void
 iface_modem_signal_init (MMIfaceModemSignal *iface)
 {
@@ -3515,6 +3525,8 @@ iface_modem_signal_init (MMIfaceModemSignal *iface)
     iface->load_values_finish = NULL;
 }
 
+#endif
+
 static void
 mm_broadband_modem_mbim_class_init (MMBroadbandModemMbimClass *klass)
 {
diff --git a/src/mm-broadband-modem-qmi.c b/src/mm-broadband-modem-qmi.c
index 2d00ed61..0c90a98e 100644
--- a/src/mm-broadband-modem-qmi.c
+++ b/src/mm-broadband-modem-qmi.c
@@ -44,7 +44,9 @@
 # include "mm-iface-modem-location.h"
 #endif
 #include "mm-iface-modem-firmware.h"
-#include "mm-iface-modem-signal.h"
+#if MM_INTERFACE_SIGNAL_SUPPORTED
+# include "mm-iface-modem-signal.h"
+#endif
 #include "mm-iface-modem-oma.h"
 #include "mm-sim-qmi.h"
 #include "mm-bearer-qmi.h"
@@ -55,7 +57,6 @@ static void iface_modem_3gpp_ussd_init (MMIfaceModem3gppUssd *iface);
 static void iface_modem_cdma_init (MMIfaceModemCdma *iface);
 static void iface_modem_oma_init (MMIfaceModemOma *iface);
 static void iface_modem_firmware_init (MMIfaceModemFirmware *iface);
-static void iface_modem_signal_init (MMIfaceModemSignal *iface);
 
 #if MM_INTERFACE_MESSAGING_SUPPORTED
 static void iface_modem_messaging_init (MMIfaceModemMessaging *iface);
@@ -67,6 +68,10 @@ static void iface_modem_location_init (MMIfaceModemLocation *iface);
 static MMIfaceModemLocation *iface_modem_location_parent;
 #endif
 
+#if MM_INTERFACE_SIGNAL_SUPPORTED
+static void iface_modem_signal_init (MMIfaceModemSignal *iface);
+#endif
+
 G_DEFINE_TYPE_EXTENDED (MMBroadbandModemQmi, mm_broadband_modem_qmi, MM_TYPE_BROADBAND_MODEM, 0,
                         G_IMPLEMENT_INTERFACE (MM_TYPE_IFACE_MODEM, iface_modem_init)
                         G_IMPLEMENT_INTERFACE (MM_TYPE_IFACE_MODEM_3GPP, iface_modem_3gpp_init)
@@ -78,7 +83,9 @@ G_DEFINE_TYPE_EXTENDED (MMBroadbandModemQmi, mm_broadband_modem_qmi, MM_TYPE_BRO
 #if MM_INTERFACE_LOCATION_SUPPORTED
                         G_IMPLEMENT_INTERFACE (MM_TYPE_IFACE_MODEM_LOCATION, iface_modem_location_init)
 #endif
+#if MM_INTERFACE_SIGNAL_SUPPORTED
                         G_IMPLEMENT_INTERFACE (MM_TYPE_IFACE_MODEM_SIGNAL, iface_modem_signal_init)
+#endif
                         G_IMPLEMENT_INTERFACE (MM_TYPE_IFACE_MODEM_OMA, iface_modem_oma_init)
                         G_IMPLEMENT_INTERFACE (MM_TYPE_IFACE_MODEM_FIRMWARE, iface_modem_firmware_init))
 
@@ -10732,6 +10739,8 @@ firmware_change_current (MMIfaceModemFirmware *self,
     qmi_message_dms_set_firmware_preference_input_unref (input);
 }
 
+#if MM_INTERFACE_SIGNAL_SUPPORTED
+
 /*****************************************************************************/
 /* Check support (Signal interface) */
 
@@ -11207,6 +11216,8 @@ signal_load_values (MMIfaceModemSignal *self,
     signal_load_values_context_step (ctx);
 }
 
+#endif /* MM_INTERFACE_SIGNAL_SUPPORTED */
+
 /*****************************************************************************/
 /* First enabling step */
 
@@ -11738,6 +11749,8 @@ iface_modem_location_init (MMIfaceModemLocation *iface)
 
 #endif /* MM_INTERFACE_LOCATION_SUPPORTED */
 
+#if MM_INTERFACE_SIGNAL_SUPPORTED
+
 static void
 iface_modem_signal_init (MMIfaceModemSignal *iface)
 {
@@ -11747,6 +11760,8 @@ iface_modem_signal_init (MMIfaceModemSignal *iface)
     iface->load_values_finish = signal_load_values_finish;
 }
 
+#endif /* MM_INTERFACE_SIGNAL_SUPPORTED */
+
 static void
 iface_modem_oma_init (MMIfaceModemOma *iface)
 {
diff --git a/src/mm-broadband-modem.c b/src/mm-broadband-modem.c
index 8a00e99d..592f5f50 100644
--- a/src/mm-broadband-modem.c
+++ b/src/mm-broadband-modem.c
@@ -50,7 +50,9 @@
 # include "mm-iface-modem-time.h"
 #endif
 #include "mm-iface-modem-firmware.h"
-#include "mm-iface-modem-signal.h"
+#if MM_INTERFACE_SIGNAL_SUPPORTED
+# include "mm-iface-modem-signal.h"
+#endif
 #include "mm-iface-modem-oma.h"
 #include "mm-broadband-bearer.h"
 #include "mm-bearer-list.h"
@@ -82,7 +84,9 @@ static void iface_modem_voice_init (MMIfaceModemVoice *iface);
 #if MM_INTERFACE_TIME_SUPPORTED
 static void iface_modem_time_init (MMIfaceModemTime *iface);
 #endif
+#if MM_INTERFACE_SIGNAL_SUPPORTED
 static void iface_modem_signal_init (MMIfaceModemSignal *iface);
+#endif
 static void iface_modem_oma_init (MMIfaceModemOma *iface);
 static void iface_modem_firmware_init (MMIfaceModemFirmware *iface);
 
@@ -104,7 +108,9 @@ G_DEFINE_TYPE_EXTENDED (MMBroadbandModem, mm_broadband_modem, MM_TYPE_BASE_MODEM
 #if MM_INTERFACE_TIME_SUPPORTED
                         G_IMPLEMENT_INTERFACE (MM_TYPE_IFACE_MODEM_TIME, iface_modem_time_init)
 #endif
+#if MM_INTERFACE_SIGNAL_SUPPORTED
                         G_IMPLEMENT_INTERFACE (MM_TYPE_IFACE_MODEM_SIGNAL, iface_modem_signal_init)
+#endif
                         G_IMPLEMENT_INTERFACE (MM_TYPE_IFACE_MODEM_OMA, iface_modem_oma_init)
                         G_IMPLEMENT_INTERFACE (MM_TYPE_IFACE_MODEM_FIRMWARE, iface_modem_firmware_init))
 
@@ -127,7 +133,9 @@ enum {
 #if MM_INTERFACE_TIME_SUPPORTED
     PROP_MODEM_TIME_DBUS_SKELETON,
 #endif
+#if MM_INTERFACE_SIGNAL_SUPPORTED
     PROP_MODEM_SIGNAL_DBUS_SKELETON,
+#endif
     PROP_MODEM_OMA_DBUS_SKELETON,
     PROP_MODEM_FIRMWARE_DBUS_SKELETON,
     PROP_MODEM_SIM,
@@ -264,9 +272,11 @@ struct _MMBroadbandModemPrivate {
     GObject *modem_time_dbus_skeleton;
 #endif
 
+#if MM_INTERFACE_SIGNAL_SUPPORTED
     /*<--- Modem Signal interface --->*/
     /* Properties */
     GObject *modem_signal_dbus_skeleton;
+#endif
 
     /*<--- Modem OMA interface --->*/
     /* Properties */
@@ -8394,6 +8404,8 @@ modem_time_check_support (MMIfaceModemTime *self,
 
 #endif /* MM_INTERFACE_TIME_SUPPORTED */
 
+#if MM_INTERFACE_SIGNAL_SUPPORTED
+
 /*****************************************************************************/
 /* Check support (Signal interface) */
 
@@ -8459,6 +8471,8 @@ modem_signal_load_values (MMIfaceModemSignal  *self,
                               user_data);
 }
 
+#endif /* MM_INTERFACE_SIGNAL_SUPPORTED */
+
 /*****************************************************************************/
 
 static const gchar *primary_init_sequence[] = {
@@ -9010,7 +9024,9 @@ typedef enum {
     DISABLING_STEP_DISCONNECT_BEARERS,
     DISABLING_STEP_IFACE_SIMPLE,
     DISABLING_STEP_IFACE_FIRMWARE,
+#if MM_INTERFACE_SIGNAL_SUPPORTED
     DISABLING_STEP_IFACE_SIGNAL,
+#endif
     DISABLING_STEP_IFACE_OMA,
 #if MM_INTERFACE_TIME_SUPPORTED
     DISABLING_STEP_IFACE_TIME,
@@ -9119,7 +9135,9 @@ INTERFACE_DISABLE_READY_FN (iface_modem_messaging, MM_IFACE_MODEM_MESSAGING, FAL
 #if MM_INTERFACE_VOICE_SUPPORTED
 INTERFACE_DISABLE_READY_FN (iface_modem_voice,     MM_IFACE_MODEM_VOICE,     FALSE)
 #endif
+#if MM_INTERFACE_SIGNAL_SUPPORTED
 INTERFACE_DISABLE_READY_FN (iface_modem_signal,    MM_IFACE_MODEM_SIGNAL,    FALSE)
+#endif
 #if MM_INTERFACE_TIME_SUPPORTED
 INTERFACE_DISABLE_READY_FN (iface_modem_time,      MM_IFACE_MODEM_TIME,      FALSE)
 #endif
@@ -9231,6 +9249,7 @@ disabling_step (GTask *task)
         /* Fall down to next step */
         ctx->step++;
 
+#if MM_INTERFACE_SIGNAL_SUPPORTED
     case DISABLING_STEP_IFACE_SIGNAL:
         if (ctx->self->priv->modem_signal_dbus_skeleton) {
             mm_dbg ("Modem has extended signal reporting capabilities, disabling the Signal interface...");
@@ -9242,6 +9261,7 @@ disabling_step (GTask *task)
         }
         /* Fall down to next step */
         ctx->step++;
+#endif
 
     case DISABLING_STEP_IFACE_OMA:
         if (ctx->self->priv->modem_oma_dbus_skeleton) {
@@ -9417,7 +9437,9 @@ typedef enum {
 #if MM_INTERFACE_TIME_SUPPORTED
     ENABLING_STEP_IFACE_TIME,
 #endif
+#if MM_INTERFACE_SIGNAL_SUPPORTED
     ENABLING_STEP_IFACE_SIGNAL,
+#endif
     ENABLING_STEP_IFACE_OMA,
     ENABLING_STEP_IFACE_FIRMWARE,
     ENABLING_STEP_IFACE_SIMPLE,
@@ -9502,7 +9524,9 @@ INTERFACE_ENABLE_READY_FN (iface_modem_messaging, MM_IFACE_MODEM_MESSAGING, FALS
 #if MM_INTERFACE_VOICE_SUPPORTED
 INTERFACE_ENABLE_READY_FN (iface_modem_voice,     MM_IFACE_MODEM_VOICE,     FALSE)
 #endif
+#if MM_INTERFACE_SIGNAL_SUPPORTED
 INTERFACE_ENABLE_READY_FN (iface_modem_signal,    MM_IFACE_MODEM_SIGNAL,    FALSE)
+#endif
 #if MM_INTERFACE_TIME_SUPPORTED
 INTERFACE_ENABLE_READY_FN (iface_modem_time,      MM_IFACE_MODEM_TIME,      FALSE)
 #endif
@@ -9708,6 +9732,7 @@ enabling_step (GTask *task)
         ctx->step++;
 #endif
 
+#if MM_INTERFACE_SIGNAL_SUPPORTED
     case ENABLING_STEP_IFACE_SIGNAL:
         if (ctx->self->priv->modem_signal_dbus_skeleton) {
             mm_dbg ("Modem has extended signal reporting capabilities, enabling the Signal interface...");
@@ -9720,6 +9745,7 @@ enabling_step (GTask *task)
         }
         /* Fall down to next step */
         ctx->step++;
+#endif
 
     case ENABLING_STEP_IFACE_OMA:
         if (ctx->self->priv->modem_oma_dbus_skeleton) {
@@ -9863,7 +9889,9 @@ typedef enum {
 #if MM_INTERFACE_TIME_SUPPORTED
     INITIALIZE_STEP_IFACE_TIME,
 #endif
+#if MM_INTERFACE_SIGNAL_SUPPORTED
     INITIALIZE_STEP_IFACE_SIGNAL,
+#endif
     INITIALIZE_STEP_IFACE_OMA,
     INITIALIZE_STEP_IFACE_FIRMWARE,
     INITIALIZE_STEP_SIM_HOT_SWAP,
@@ -10056,7 +10084,9 @@ INTERFACE_INIT_READY_FN (iface_modem_voice,     MM_IFACE_MODEM_VOICE,     FALSE)
 #if MM_INTERFACE_TIME_SUPPORTED
 INTERFACE_INIT_READY_FN (iface_modem_time,      MM_IFACE_MODEM_TIME,      FALSE)
 #endif
+#if MM_INTERFACE_SIGNAL_SUPPORTED
 INTERFACE_INIT_READY_FN (iface_modem_signal,    MM_IFACE_MODEM_SIGNAL,    FALSE)
+#endif
 INTERFACE_INIT_READY_FN (iface_modem_oma,       MM_IFACE_MODEM_OMA,       FALSE)
 INTERFACE_INIT_READY_FN (iface_modem_firmware,  MM_IFACE_MODEM_FIRMWARE,  FALSE)
 
@@ -10192,6 +10222,7 @@ initialize_step (GTask *task)
         return;
 #endif
 
+#if MM_INTERFACE_SIGNAL_SUPPORTED
     case INITIALIZE_STEP_IFACE_SIGNAL:
         /* Initialize the Signal interface */
         mm_iface_modem_signal_initialize (MM_IFACE_MODEM_SIGNAL (ctx->self),
@@ -10199,6 +10230,7 @@ initialize_step (GTask *task)
                                           (GAsyncReadyCallback)iface_modem_signal_initialize_ready,
                                           task);
         return;
+#endif
 
     case INITIALIZE_STEP_IFACE_OMA:
         /* Initialize the Oma interface */
@@ -10328,6 +10360,9 @@ sim_hot_swap_enabled:
 #endif
 #if MM_INTERFACE_TIME_SUPPORTED
                 mm_iface_modem_time_shutdown (MM_IFACE_MODEM_TIME (ctx->self));
+#endif
+#if MM_INTERFACE_SIGNAL_SUPPORTED
+                mm_iface_modem_signal_shutdown (MM_IFACE_MODEM_SIGNAL (ctx->self));
 #endif
                 mm_iface_modem_simple_shutdown (MM_IFACE_MODEM_SIMPLE (ctx->self));
             }
@@ -10581,10 +10616,12 @@ set_property (GObject *object,
         self->priv->modem_time_dbus_skeleton = g_value_dup_object (value);
         break;
 #endif
+#if MM_INTERFACE_SIGNAL_SUPPORTED
     case PROP_MODEM_SIGNAL_DBUS_SKELETON:
         g_clear_object (&self->priv->modem_signal_dbus_skeleton);
         self->priv->modem_signal_dbus_skeleton = g_value_dup_object (value);
         break;
+#endif
     case PROP_MODEM_OMA_DBUS_SKELETON:
         g_clear_object (&self->priv->modem_oma_dbus_skeleton);
         self->priv->modem_oma_dbus_skeleton = g_value_dup_object (value);
@@ -10709,9 +10746,11 @@ get_property (GObject *object,
         g_value_set_object (value, self->priv->modem_time_dbus_skeleton);
         break;
 #endif
+#if MM_INTERFACE_SIGNAL_SUPPORTED
     case PROP_MODEM_SIGNAL_DBUS_SKELETON:
         g_value_set_object (value, self->priv->modem_signal_dbus_skeleton);
         break;
+#endif
     case PROP_MODEM_OMA_DBUS_SKELETON:
         g_value_set_object (value, self->priv->modem_oma_dbus_skeleton);
         break;
@@ -11139,6 +11178,8 @@ iface_modem_time_init (MMIfaceModemTime *iface)
 
 #endif
 
+#if MM_INTERFACE_SIGNAL_SUPPORTED
+
 static void
 iface_modem_signal_init (MMIfaceModemSignal *iface)
 {
@@ -11148,6 +11189,8 @@ iface_modem_signal_init (MMIfaceModemSignal *iface)
     iface->load_values_finish   = modem_signal_load_values_finish;
 }
 
+#endif
+
 static void
 iface_modem_oma_init (MMIfaceModemOma *iface)
 {
@@ -11233,9 +11276,11 @@ mm_broadband_modem_class_init (MMBroadbandModemClass *klass)
                                       MM_IFACE_MODEM_TIME_DBUS_SKELETON);
 #endif
 
+#if MM_INTERFACE_SIGNAL_SUPPORTED
     g_object_class_override_property (object_class,
                                       PROP_MODEM_SIGNAL_DBUS_SKELETON,
                                       MM_IFACE_MODEM_SIGNAL_DBUS_SKELETON);
+#endif
 
     g_object_class_override_property (object_class,
                                       PROP_MODEM_OMA_DBUS_SKELETON,
diff --git a/src/mm-modem-helpers.c b/src/mm-modem-helpers.c
index 365dc8ba..8a0baa8e 100644
--- a/src/mm-modem-helpers.c
+++ b/src/mm-modem-helpers.c
@@ -2091,6 +2091,8 @@ out:
     return TRUE;
 }
 
+#if MM_INTERFACE_SIGNAL_SUPPORTED
+
 /*****************************************************************************/
 /* +CESQ response parser */
 
@@ -2332,6 +2334,8 @@ mm_3gpp_cesq_response_to_signal_info (const gchar  *response,
     return TRUE;
 }
 
+#endif /* MM_INTERFACE_SIGNAL_SUPPORTED */
+
 gboolean
 mm_3gpp_parse_cfun_query_generic_response (const gchar        *response,
                                            MMModemPowerState  *out_state,
diff --git a/src/mm-modem-helpers.h b/src/mm-modem-helpers.h
index e0a21a05..18cd9b43 100644
--- a/src/mm-modem-helpers.h
+++ b/src/mm-modem-helpers.h
@@ -273,22 +273,6 @@ gboolean mm_3gpp_parse_cfun_query_generic_response (const gchar        *response
                                                     MMModemPowerState  *out_state,
                                                     GError            **error);
 
-/* +CESQ response parser */
-gboolean mm_3gpp_parse_cesq_response (const gchar  *response,
-                                      guint        *out_rxlev,
-                                      guint        *out_ber,
-                                      guint        *out_rscp,
-                                      guint        *out_ecn0,
-                                      guint        *out_rsrq,
-                                      guint        *out_rsrp,
-                                      GError      **error);
-
-gboolean mm_3gpp_cesq_response_to_signal_info (const gchar  *response,
-                                               MMSignal    **out_gsm,
-                                               MMSignal    **out_umts,
-                                               MMSignal    **out_lte,
-                                               GError      **error);
-
 /* Additional 3GPP-specific helpers */
 
 MMModem3gppFacility mm_3gpp_acronym_to_facility (const gchar *str);
@@ -309,6 +293,30 @@ MMBearerIpFamily  mm_3gpp_get_ip_family_from_pdp_type (const gchar *pdp_type);
 
 char *mm_3gpp_parse_iccid (const char *raw_iccid, GError **error);
 
+#if MM_INTERFACE_SIGNAL_SUPPORTED
+
+/*****************************************************************************/
+/* Signal specific helpers and utilities */
+/*****************************************************************************/
+
+/* +CESQ response parser */
+gboolean mm_3gpp_parse_cesq_response (const gchar  *response,
+                                      guint        *out_rxlev,
+                                      guint        *out_ber,
+                                      guint        *out_rscp,
+                                      guint        *out_ecn0,
+                                      guint        *out_rsrq,
+                                      guint        *out_rsrp,
+                                      GError      **error);
+
+gboolean mm_3gpp_cesq_response_to_signal_info (const gchar  *response,
+                                               MMSignal    **out_gsm,
+                                               MMSignal    **out_umts,
+                                               MMSignal    **out_lte,
+                                               GError      **error);
+
+#endif /* MM_INTERFACE_SIGNAL_SUPPORTED */
+
 #if MM_INTERFACE_MESSAGING_SUPPORTED
 
 /*****************************************************************************/
diff --git a/src/tests/test-modem-helpers.c b/src/tests/test-modem-helpers.c
index 39257452..56230845 100644
--- a/src/tests/test-modem-helpers.c
+++ b/src/tests/test-modem-helpers.c
@@ -3528,6 +3528,8 @@ test_cfun_response (void)
     }
 }
 
+#if MM_INTERFACE_SIGNAL_SUPPORTED
+
 /*****************************************************************************/
 /* Test +CESQ responses */
 
@@ -3648,6 +3650,8 @@ test_cesq_response_to_signal (void)
     }
 }
 
+#endif /* MM_INTERFACE_SIGNAL_SUPPORTED */
+
 typedef struct {
     const gchar       *str;
     MMModemPowerState  state;
@@ -3950,8 +3954,10 @@ int main (int argc, char **argv)
     g_test_suite_add (suite, TESTCASE (test_cfun_response, NULL));
     g_test_suite_add (suite, TESTCASE (test_cfun_generic_response, NULL));
 
+#if MM_INTERFACE_SIGNAL_SUPPORTED
     g_test_suite_add (suite, TESTCASE (test_cesq_response, NULL));
     g_test_suite_add (suite, TESTCASE (test_cesq_response_to_signal, NULL));
+#endif
 
     g_test_suite_add (suite, TESTCASE (test_parse_uint_list, NULL));
 
-- 
2.14.1

