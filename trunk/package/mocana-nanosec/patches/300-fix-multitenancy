diff -u -r a/mss_2013_10_31_33895/src/common/moptions_custom.h b/mss_2013_10_31_33895/src/common/moptions_custom.h
--- a/mss_2013_10_31_33895/src/common/moptions_custom.h	2014-03-18 11:33:35.000000000 -0700
+++ b/mss_2013_10_31_33895/src/common/moptions_custom.h	2014-03-21 16:18:51.021115941 -0700
@@ -37,6 +37,8 @@
 #define __MOCANA_DUMP_CONSOLE_TO_STDOUT__
 #endif /* KERNEL_CREATE_DEVICE */
 
+#define __ENABLE_IPSEC_COOKIE__
+#define USE_MOC_COOKIE
 
 /*------------------------------------------------------------------*/
 #ifdef __cplusplus
diff -u -r a/mss_2013_10_31_33895/src/ipsec/spd.c b/mss_2013_10_31_33895/src/ipsec/spd.c
--- a/mss_2013_10_31_33895/src/ipsec/spd.c	2013-11-08 11:39:19.000000000 -0800
+++ b/mss_2013_10_31_33895/src/ipsec/spd.c	2014-03-21 16:20:52.905106804 -0700
@@ -740,6 +740,9 @@
 #ifdef __ENABLE_IPSEC_INTERFACE_ID__
         key.ifid            = pxConf->ifid;
 #endif
+#ifdef USE_MOC_COOKIE
+        key.cookie          = pxConf->cookie;
+#endif
         IPSEC_keyInitiate(&key);
     }
 #endif /* __ENABLE_MOCANA_IKE_SERVER__ */
@@ -1190,6 +1193,9 @@
         if (pxSp->cookie && (pxKey->cookie != pxSp->cookie))
             continue;
 #endif
+        /* Don't match SPD if mode does not match */
+        if ((!bIke) && (pxSp->oMode != pxKey->oMode))
+            continue;
 
         /* match traffic selector */
         if (pxSp->oProto)
